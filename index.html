<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mumbai South Zone, Planning Department</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --accent:#007bff;
    --card:#ffffff;
    --muted:#6b7280;
    --btn:#ff9800;
    --success:#25D366;
    --danger:#ef4444;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:#f3f7fb; color:#0f172a;}
  body.dark{ background:#0b1220; color:#e6eef8; }
  .topbar{ display:flex; align-items:center; justify-content:space-between; padding:14px 18px; background: linear-gradient(90deg,#003d80,#007bff); color:white; }
  .title{ font-size:18px; font-weight:700; letter-spacing:0.2px; }
  .card{ max-width:1100px; margin:18px auto; background:var(--card); border-radius:12px; padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.08); }
  body.dark .card{ background:#0f1724; box-shadow:none; border:1px solid #19202a; }

  .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
  .status{ color:var(--muted); font-size:13px; margin-bottom:12px; }

  .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; cursor:pointer; border:0; font-weight:700; }
  .btn-primary { background: linear-gradient(90deg,var(--btn),#ffb74d); color:#111; }
  .btn-muted { background:transparent; border:1px solid rgba(15,23,42,0.06); color:var(--muted); }
  .btn-refresh { background:#3742fa; color:white; }

  table{ width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
  th, td{ padding:12px; border:1px solid rgba(15,23,42,0.06); vertical-align:top; text-align:left; }
  th{ background:linear-gradient(90deg,#f8fafc,#eef5ff); font-weight:700; }
  pre.msg { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; margin:0; line-height:1.35; background:transparent; border:0; padding:0; color:inherit; }

  .action-buttons{ display:flex; gap:8px; flex-wrap:wrap; }
  .wa-btn{ background:var(--success); color:white; padding:8px 12px; border-radius:8px; text-decoration:none; display:inline-block; font-weight:700; }
  .copy-btn{ background:#ffd166; color:#111; padding:8px 12px; border-radius:8px; font-weight:700; border:none; cursor:pointer; }

  .pager{ display:flex; justify-content:flex-end; gap:10px; align-items:center; margin-top:12px; }
  .pager button{ padding:8px 12px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; }

  .meta{ color:var(--muted); font-size:13px; margin-top:8px; }
  .small{ font-size:13px; color:var(--muted); }

  @media (max-width:900px){
    .controls{ flex-direction:column; align-items:flex-start; gap:10px; }
  }

  /* Simple login overlay */
  #loginOverlay{
    position:fixed;
    inset:0;
    background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .loginBox{
    width:360px;
    background:white;
    border-radius:10px;
    padding:22px;
    box-shadow:0 12px 40px rgba(2,6,23,0.4);
    text-align:center;
    font-family:Inter, Arial, sans-serif;
  }
  .loginBox h2{ margin:0 0 10px 0; font-size:18px; color:#0f172a; }
  .loginBox p{ margin:0 0 12px 0; color:#475569; font-size:13px; }
  .loginBox input[type=password]{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:12px; }
  .loginBox button{ width:100%; padding:10px 12px; border-radius:8px; border:0; font-weight:700; background:#0b63d6; color:white; cursor:pointer; }
  .loginError{ color:#ef4444; font-size:13px; height:18px; margin-top:8px; }
  .loginSmall{ font-size:12px; color:#6b7280; margin-top:10px; }
  body.dark .loginBox{ background:#071022; color:#e6eef8; box-shadow:none; border:1px solid #102131; }
  body.dark .loginBox p{ color:#9fb0ca; }
  body.dark .loginBox input[type=password]{ background:#071022; color:#e6eef8; border:1px solid #1f3947; }

  /* loading spinner small */
  .spinner {
    width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.2); border-top-color:white; animation:spin 1s linear infinite; display:inline-block;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

</style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" aria-hidden="false">
    <div class="loginBox" role="dialog" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Portal Login</h2>
      <p>Enter password to access Zonal WhatsApp portal</p>
      <input id="loginPassword" type="password" placeholder="Enter password" autocomplete="off" />
      <button id="loginBtn">Login</button>
      <div class="loginError" id="loginError"></div>
      <div class="loginSmall">This is light client-side protection. For higher security use a server-based login.</div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" style="display:none;">
    <div class="topbar">
      <div class="title">Mumbai South Zone, Planning Department</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="darkToggle" class="btn btn-muted">ð Dark Mode</button>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="refreshBtn" class="btn btn-refresh">Refresh Data</button>
          <button id="downloadPdfBtn" class="btn btn-muted">Download All as PDF</button>
        </div>
        <div style="margin-left:auto; text-align:right;">
          <div class="small" id="loadedFileInfo">Loading latest fileâ¦</div>
          <div class="small" id="loadStatus"></div>
        </div>
      </div>

      <div class="status" id="statusMsg">The portal automatically loads the latest <code>msz_YYYY-MM-DD.xlsx</code> from the repository root.</div>

      <div id="tableWrap" style="margin-top:8px;"></div>

      <div id="pager" class="pager" style="display:none;">
        <div id="pageInfo"></div>
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
      </div>

      <div class="meta" style="margin-top:12px;">
        Upload daily file to your repo root named <code>msz_YYYY-MM-DD.xlsx</code>. After uploading, click <b>Refresh Data</b> or reload the page.
      </div>
    </div>
  </div>

<script>
(function(){
  // CONFIG: change these if your repo/owner/branch differ
  const GITHUB_OWNER = 'leoxvinci';
  const GITHUB_REPO  = 'MSZ-PMI';
  const GITHUB_BRANCH = 'main';
  const FILENAME_PREFIX = 'msz_'; // expects msz_YYYY-MM-DD.xlsx
  const SIMPLE_FALLBACK = 'msz.xlsx'; // optional fallback
  const APP_SESSION_KEY = 'msz_logged_in_v1';
  const PASSWORD = 'admin@123';

  // Pagination
  const perPage = 10;
  let messages = [];
  let currentPage = 1;
  const el = id => document.getElementById(id);

  // Login logic
  const loginOverlay = el('loginOverlay');
  const loginBtn = el('loginBtn');
  const loginInput = el('loginPassword');
  const loginError = el('loginError');
  const appDiv = el('app');

  function showApp(){
    loginOverlay.style.display = 'none';
    appDiv.style.display = 'block';
    sessionStorage.setItem(APP_SESSION_KEY, '1');
    // Start loading automatically
    loadLatestAndRender();
  }
  function lockApp(){
    loginOverlay.style.display = 'flex';
    appDiv.style.display = 'none';
    sessionStorage.removeItem(APP_SESSION_KEY);
  }
  if(sessionStorage.getItem(APP_SESSION_KEY) === '1'){ showApp(); }

  loginBtn.addEventListener('click', ()=>{
    const v = loginInput.value || '';
    if(v === PASSWORD){
      loginError.textContent = '';
      showApp();
    } else {
      loginError.textContent = 'Incorrect password';
      loginInput.value = '';
      loginInput.focus();
    }
  });
  loginInput.addEventListener('keypress', (e)=>{ if(e.key === 'Enter') loginBtn.click(); });

  // Utilities
  function formatDatePrettyFromISO(iso){
    const d = new Date(iso);
    if(isNaN(d)) return iso;
    const day = d.getDate();
    const ord = (n)=> {
      if (n%10==1 && n%100!=11) return n+'st';
      if (n%10==2 && n%100!=12) return n+'nd';
      if (n%10==3 && n%100!=13) return n+'rd';
      return n+'th';
    };
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${ord(day)} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function sanitizeMobile(m){
    if(!m && m !== 0) return '';
    let s = String(m).replace(/\s|\(|\)|\-|\+/g,'');
    if(s.length===10) s = '91'+s;
    if(s.startsWith('0')) s = s.replace(/^0+/, '');
    s = s.replace(/[^0-9]/g,'');
    return s;
  }

  function emoji(v){
    const n = parseFloat(String(v).replace(/[,Â¹\s]/g,'')) || 0;
    return n < 0 ? 'ð´' : 'ð¢';
  }

  function formatNumber(v){
    return Number(v||0).toFixed(2);
  }

  function buildMessage(row, prettyDate){
    const branch = row[1] || "";
    const head = row[2] || "";
    const r = (i) => row[i]===undefined||row[i]===null||row[i]==='' ? "0.00" : Number(row[i]).toFixed(2);

    const lines = [];
    lines.push(`Good Afternoon ${head},`);
    lines.push(``);
    lines.push(`ð Performance of ${branch} Branch as on ${prettyDate}`);
    lines.push(``);

    const sections = [
      {name:'ð¦ CASA', start:4},
      {name:'ð° Retail TDR', start:8},
      {name:'ð¡ Retail Loans', start:12},
      {name:'ð¢ MSME Loans', start:16},
      {name:'ð¾ Agricultural Loans', start:20},
    ];

    sections.forEach(sec => {
      lines.push(sec.name);
      lines.push(`--------------------------------`);
      lines.push(`O/S        : â¹ ${r(sec.start)} Cr`);
      lines.push(`YTD        : â¹ ${r(sec.start+1)} Cr   ${emoji(row[sec.start+1])}`);
      lines.push(`Budget     : â¹ ${r(sec.start+2)} Cr`);
      lines.push(`Bud.Gap    : â¹ ${r(sec.start+3)} Cr   ${emoji(row[sec.start+3])}`);
      lines.push(``);
    });

    lines.push(`ð Please focus on red-flagged areas today and come out of the negativity at the earliest.`);
    lines.push(``);
    lines.push(`Regards,`);
    lines.push(`Planning Department`);
    lines.push(`Mumbai South Zone`);

    return lines.join("\n");
  }

  // Rendering and UI
  function renderPage(page){
    const wrap = el('tableWrap');
    if(!messages.length){
      wrap.innerHTML = '<div style="padding:18px;color:#6b7280;">No data loaded.</div>';
      el('pager').style.display='none';
      return;
    }
    const start = (page-1)*perPage;
    const chunk = messages.slice(start, start+perPage);

    let html = '<table><thead><tr><th>Branch Name</th><th>Generated Message</th><th>Actions</th></tr></thead><tbody>';
    chunk.forEach((m, idx)=>{
      const pre = `<pre class="msg">${escapeHtml(m.msg)}</pre>`;
      const mobile = sanitizeMobile(m.mobile);
      const waLink = mobile ? `https://wa.me/${mobile}?text=${encodeURIComponent(m.msg)}` : '#';
      html += `<tr>
        <td><strong>${escapeHtml(m.branch)}</strong></td>
        <td>${pre}</td>
        <td>
          <div class="action-buttons">
            <a class="wa-btn" href="${waLink}" target="_blank" rel="noopener">Send</a>
            <button class="copy-btn" data-index="${start+idx}">Copy</button>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;

    const totalPages = Math.ceil(messages.length / perPage);
    el('pager').style.display = totalPages>1 ? 'flex' : 'none';
    el('pageInfo').textContent = `Page ${page} of ${totalPages}`;

    document.querySelectorAll('.copy-btn').forEach(b=>{
      b.onclick = () => {
        const i = Number(b.getAttribute('data-index'));
        navigator.clipboard.writeText(messages[i].msg).then(()=> {
          const old = b.textContent;
          b.textContent = 'Copied';
          setTimeout(()=> b.textContent = old, 1400);
        });
      };
    });
  }

  // GitHub helpers: list contents and fetch raw file
  async function listRepoRoot(){
    // list files using GitHub API
    const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents?ref=${GITHUB_BRANCH}`;
    const r = await fetch(url).then(res=>{
      if(!res.ok) throw new Error(`GitHub API error: ${res.status}`);
      return res.json();
    });
    return r; // array of file objects
  }

  function parseDateFromFilename(name){
    // accept msz_YYYY-MM-DD.xlsx or MSZ_YYYY-MM-DD.xlsx (case-insensitive prefix)
    const re = /msz_(\d{4})-(\d{2})-(\d{2})\.xlsx$/i;
    const m = name.match(re);
    if(!m) return null;
    return `${m[1]}-${m[2]}-${m[3]}`; // ISO-like string
  }

  function chooseLatestFile(list){
    // returns filename and date
    let candidates = [];
    list.forEach(item=>{
      if(item && item.name){
        const d = parseDateFromFilename(item.name);
        if(d) candidates.push({name:item.name, date:d});
      }
    });
    if(candidates.length === 0){
      // fallback to simple msz.xlsx if present
      const found = list.find(it => it && it.name && it.name.toLowerCase() === SIMPLE_FALLBACK);
      if(found) return {name:found.name, date: (new Date()).toISOString().slice(0,10)};
      return null;
    }
    // choose max date (string compare works for YYYY-MM-DD)
    candidates.sort((a,b)=> b.date.localeCompare(a.date));
    return candidates[0];
  }

  async function fetchExcelAsArrayBuffer(filename){
    const rawUrl = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${encodeURIComponent(filename)}`;
    const res = await fetch(rawUrl);
    if(!res.ok) throw new Error(`Failed fetching file: ${res.status}`);
    const ab = await res.arrayBuffer();
    return ab;
  }

  async function loadLatestAndRender(showSpinner=true){
    el('loadedFileInfo').textContent = 'Loading latest fileâ¦';
    el('loadStatus').textContent = showSpinner ? 'Checking repository...' : '';
    try{
      const contents = await listRepoRoot();
      const pick = chooseLatestFile(contents);
      if(!pick){
        el('loadedFileInfo').textContent = 'No msz_YYYY-MM-DD.xlsx found in repo root.';
        el('loadStatus').textContent = 'Please upload file to repo root and try Refresh.';
        messages = [];
        renderPage(1);
        return;
      }

      el('loadedFileInfo').textContent = `${pick.name}`;
      el('loadStatus').textContent = 'Downloading XLSX...';
      const ab = await fetchExcelAsArrayBuffer(pick.name);
      el('loadStatus').textContent = 'Parsing XLSX...';

      // parse workbook
      const workbook = XLSX.read(new Uint8Array(ab), { type:'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header:1, blankrows:false });

      const prettyDate = formatDatePrettyFromISO(pick.date);
      messages = [];
      currentPage = 1;
      for(let i=3;i<rows.length;i++){
        const row = rows[i];
        if(!row || !row[1]) continue;
        const branch = row[1] || '';
        const mobile = row[3] || '';
        const msg = buildMessage(row, prettyDate);
        messages.push({ branch, mobile, msg });
      }

      if(messages.length === 0){
        el('loadStatus').textContent = 'No valid rows found starting from row 4 in the Excel.';
        el('loadedFileInfo').textContent = pick.name + ' (no rows)';
        renderPage(1);
        return;
      }

      el('loadStatus').textContent = `Loaded ${messages.length} records from ${pick.name}`;
      renderPage(1);
    } catch(err){
      console.error(err);
      el('loadedFileInfo').textContent = 'Error loading file';
      el('loadStatus').textContent = String(err.message || err);
      messages = [];
      renderPage(1);
    }
  }

  // Refresh button
  el('refreshBtn').addEventListener('click', ()=> {
    el('loadStatus').textContent = 'Refreshingâ¦';
    loadLatestAndRender(true);
  });

  // Download PDF (simple)
  el('downloadPdfBtn').addEventListener('click', async ()=>{
    if(!messages.length){ alert('No messages to export'); return; }
    // lazy-load jsPDF via CDN
    try{
      if(!window.jspdf){
        await new Promise((resolve, reject)=>{
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          s.onload = resolve;
          s.onerror = reject;
          document.head.appendChild(s);
        });
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
      let y = 40;
      messages.forEach((m, idx)=>{
        doc.setFontSize(13);
        doc.text(`Branch: ${m.branch}`, 40, y);
        y += 18;
        doc.setFontSize(10);
        const lines = doc.splitTextToSize(m.msg, 520);
        lines.forEach(line=>{
          if(y > 780){
            doc.addPage();
            y = 40;
          }
          doc.text(line, 40, y);
          y += 14;
        });
        y += 18;
        if(idx !== messages.length-1){
          doc.setDrawColor(200);
          doc.line(40, y, 560, y);
          y += 22;
        }
      });
      doc.save('All_Messages.pdf');
    } catch(e){
      alert('Failed to load PDF library: '+e.message);
    }
  });

  // Pagination buttons
  el('prevBtn').addEventListener('click', ()=>{
    if(currentPage>1){ currentPage--; renderPage(currentPage); }
  });
  el('nextBtn').addEventListener('click', ()=>{
    const totalPages = Math.ceil(messages.length / perPage);
    if(currentPage < totalPages){ currentPage++; renderPage(currentPage); }
  });

  // Dark mode
  el('darkToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    el('darkToggle').textContent = document.body.classList.contains('dark') ? 'âï¸ Light Mode' : 'ð Dark Mode';
  });

  // Initial state: do nothing until login
})();
</script>
</body>
</html>