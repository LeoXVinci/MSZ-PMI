<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mumbai South Zone, Planning Department</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --accent:#007bff;
    --card:#ffffff;
    --muted:#6b7280;
    --btn:#ff9800;
    --success:#25D366;
    --danger:#ef4444;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:#f3f7fb; color:#0f172a;}
  body.dark{ background:#0b1220; color:#e6eef8; }
  .topbar{ display:flex; align-items:center; justify-content:space-between; padding:18px 24px; background: linear-gradient(90deg,#003d80,#007bff); color:white; }
  .title{ font-size:20px; font-weight:700; letter-spacing:0.2px; }
  .controls{ display:flex; gap:10px; align-items:center; }
  .card{ max-width:1100px; margin:20px auto; background:var(--card); border-radius:12px; padding:18px; box-shadow:0 8px 30px rgba(2,6,23,0.08); }
  body.dark .card{ background:#0f1724; box-shadow:none; border:1px solid #19202a; }

  label{ font-weight:600; color:var(--muted); display:block; margin-bottom:6px; }
  input[type=date], input[type=file], .btn-primary { width:260px; padding:10px 12px; border-radius:8px; border:1px solid #cfd8e3; }
  body.dark input[type=date], body.dark input[type=file]{ background:#071022; color:#e6eef8; border-color:#24303b; }

  .btn { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:8px; cursor:pointer; border:0; font-weight:700; }
  .btn-generate { background: linear-gradient(90deg,var(--btn),#ffb74d); color:#111; }
  .btn-toggle { background: rgba(255,255,255,0.08); color:white; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); }

  table{ width:100%; border-collapse:collapse; margin-top:18px; font-size:14px; }
  th, td{ padding:12px; border:1px solid rgba(15,23,42,0.06); vertical-align:top; }
  th{ background:linear-gradient(90deg,#f8fafc,#eef5ff); text-align:left; font-weight:700; }
  body.dark th{ background:linear-gradient(90deg,#071a2b,#071a2b); }
  pre.msg { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; margin:0; line-height:1.35; background:transparent; border:0; padding:0; color:inherit; }

  .action-buttons{ display:flex; gap:8px; flex-wrap:wrap; }
  .wa-btn{ background:var(--success); color:white; padding:8px 12px; border-radius:8px; text-decoration:none; display:inline-block; font-weight:700; }
  .copy-btn{ background:#ffd166; color:#111; padding:8px 12px; border-radius:8px; font-weight:700; border:none; cursor:pointer; }

  .pager{ display:flex; justify-content:flex-end; gap:10px; align-items:center; margin-top:12px; }
  .pager button{ padding:8px 12px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:transparent; cursor:pointer; }

  .meta{ color:var(--muted); font-size:13px; margin-top:8px; }
  @media (max-width:900px){
    .controls{ flex-direction:column; align-items:flex-start; gap:12px; }
    input[type=date], input[type=file]{ width:100%; }
  }

  /* Simple login overlay */
  #loginOverlay{
    position:fixed;
    inset:0;
    background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.6));
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }
  .loginBox{
    width:360px;
    background:white;
    border-radius:10px;
    padding:22px;
    box-shadow:0 12px 40px rgba(2,6,23,0.4);
    text-align:center;
    font-family:Inter, Arial, sans-serif;
  }
  .loginBox h2{ margin:0 0 10px 0; font-size:18px; color:#0f172a; }
  .loginBox p{ margin:0 0 18px 0; color:#475569; font-size:13px; }
  .loginBox input[type=password]{ width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:12px; }
  .loginBox button{ width:100%; padding:10px 12px; border-radius:8px; border:0; font-weight:700; background:#0b63d6; color:white; cursor:pointer; }
  .loginError{ color:#ef4444; font-size:13px; height:18px; margin-top:8px; }
  .loginSmall{ font-size:12px; color:#6b7280; margin-top:10px; }
  body.dark .loginBox{ background:#071022; color:#e6eef8; box-shadow:none; border:1px solid #102131; }
  body.dark .loginBox p{ color:#9fb0ca; }
  body.dark .loginBox input[type=password]{ background:#071022; color:#e6eef8; border:1px solid #1f3947; }
</style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" aria-hidden="false">
    <div class="loginBox" role="dialog" aria-labelledby="loginTitle">
      <h2 id="loginTitle">Portal Login</h2>
      <p>Enter password to access the Zonal WhatsApp portal</p>
      <input id="loginPassword" type="password" placeholder="Enter password" autocomplete="off" />
      <button id="loginBtn">Login</button>
      <div class="loginError" id="loginError"></div>
      <div class="loginSmall">This is light client-side protection. For higher security use a server-based login.</div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app" style="display:none;">
    <div class="topbar">
      <div class="title">Mumbai South Zone, Planning Department</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="darkToggle" class="btn btn-toggle">ðŸŒ™ Dark Mode</button>
      </div>
    </div>

    <div class="card">
      <div style="display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
        <div>
          <label for="reportDate">Select Date</label>
          <input type="date" id="reportDate" />
        </div>
        <div>
          <label for="excelFile">Upload Excel (.xlsx / .xls). Data starts from row 4</label>
          <input type="file" id="excelFile" accept=".xlsx,.xls" />
        </div>
        <div style="align-self:end;">
          <button id="generateBtn" class="btn btn-generate">Generate Messages</button>
        </div>
      </div>

      <div class="meta">After generating, table shows Branch | Generated message | Actions (Send / Copy). Pagination below (10 rows per page).</div>

      <div id="tableWrap" style="margin-top:18px;"></div>

      <div id="pager" class="pager" style="display:none;">
        <div id="pageInfo"></div>
        <button id="prevBtn">Prev</button>
        <button id="nextBtn">Next</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------------------------
  // Password gate (Option A)
  // ---------------------------
  const APP_SESSION_KEY = 'msz_logged_in_v1';
  const PASSWORD = 'admin@123'; // Simple client-side password (Option A)

  const loginOverlay = document.getElementById('loginOverlay');
  const loginBtn = document.getElementById('loginBtn');
  const loginInput = document.getElementById('loginPassword');
  const loginError = document.getElementById('loginError');
  const appDiv = document.getElementById('app');

  function showApp(){
    loginOverlay.style.display = 'none';
    appDiv.style.display = 'block';
    sessionStorage.setItem(APP_SESSION_KEY, '1');
  }

  function lockApp(){
    loginOverlay.style.display = 'flex';
    appDiv.style.display = 'none';
    sessionStorage.removeItem(APP_SESSION_KEY);
  }

  // If already logged in in this session, show app
  if(sessionStorage.getItem(APP_SESSION_KEY) === '1'){
    showApp();
  }

  loginBtn.addEventListener('click', ()=>{
    const v = loginInput.value || '';
    if(v === PASSWORD){
      loginError.textContent = '';
      showApp();
    } else {
      loginError.textContent = 'Incorrect password';
      loginInput.value = '';
      loginInput.focus();
    }
  });

  // allow pressing Enter
  loginInput.addEventListener('keypress', (e)=>{
    if(e.key === 'Enter') loginBtn.click();
  });

  // ---------------------------
  // Main App code (unchanged functionality)
  // ---------------------------
  const perPage = 10;
  let messages = [];
  let currentPage = 1;

  const el = id => document.getElementById(id);
  const formatDatePretty = (iso) => {
    const d = new Date(iso);
    if (isNaN(d)) return iso;
    const day = d.getDate();
    const ord = (n)=> {
      if (n%10==1 && n%100!=11) return n+'st';
      if (n%10==2 && n%100!=12) return n+'nd';
      if (n%10==3 && n%100!=13) return n+'rd';
      return n+'th';
    };
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return ord(day) + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
  };

  const sanitizeMobile = (m) => {
    if(!m && m!==0) return '';
    let s = String(m).replace(/\s|\(|\)|\-|\+/g,'');
    if(s.length===10) s = '91'+s;
    if(s.startsWith('0')) s = s.replace(/^0+/, '');
    s = s.replace(/[^0-9]/g,'');
    return s;
  };

  const emoji = (v) => {
    const n = parseFloat(String(v).replace(/[,Â¹\s]/g,'')) || 0;
    return n < 0 ? 'ðŸ”´' : 'ðŸŸ¢';
  };

  const buildMessage = (row, prettyDate) => {
    const branch = row[1] || "";
    const head = row[2] || "";
    const r = (i) => row[i]===undefined||row[i]===null||row[i]==='' ? "0.00" : Number(row[i]).toFixed(2);

    const lines = [];

    lines.push(`Dear ${head},`);
    lines.push(`ðŸ“Š Performance of ${branch} Branch as on ${prettyDate} -`);
    lines.push(``);

    const sections = [
      {name:'ðŸ¦ CASA', start:4},
      {name:'ðŸ’° Retail TDR', start:8},
      {name:'ðŸ¡ Retail Loans', start:12},
      {name:'ðŸ¢ MSME Loans', start:16},
      {name:'ðŸŒ¾ Agricultural Loans', start:20},
    ];

    sections.forEach(sec => {
      lines.push(sec.name);
      lines.push(`--------------------------------`);
      lines.push(`O/S       : â‚¹ ${r(sec.start)} Cr`);
      lines.push(`YTD       : â‚¹ ${r(sec.start+1)} Cr      ${emoji(row[sec.start+1])}`);
      lines.push(`Budget    : â‚¹ ${r(sec.start+2)} Cr`);
      lines.push(`Bud.Gap   : â‚¹ ${r(sec.start+3)} Cr      ${emoji(row[sec.start+3])}`);
      lines.push(``);
    });

    lines.push(`ðŸ“Œ Please focus on red-flagged areas today and come out of the negativity at the earliest.`);
    lines.push(``);
    lines.push(`Regards,`);
    lines.push(`Zonal Manager`);
    lines.push(`Mumbai South Zone`);

    return lines.join("\n");
  };

  function renderPage(page){
    const wrap = el('tableWrap');
    if(!messages.length){ wrap.innerHTML = '<div style="padding:18px;color:#6b7280;">No data. Upload file and click Generate.</div>'; el('pager').style.display='none'; return; }
    const start = (page-1)*perPage;
    const chunk = messages.slice(start, start+perPage);

    let html = '<table><thead><tr><th>Branch Name</th><th>Generated Message</th><th>Actions</th></tr></thead><tbody>';
    chunk.forEach((m, idx)=>{
      const pre = `<pre class="msg">${escapeHtml(m.msg)}</pre>`;
      const mobile = sanitizeMobile(m.mobile);
      const waLink = mobile ? `https://wa.me/${mobile}?text=${encodeURIComponent(m.msg)}` : '#';
      html += `<tr>
        <td><strong>${escapeHtml(m.branch)}</strong></td>
        <td>${pre}</td>
        <td>
          <div class="action-buttons">
            <a class="wa-btn" href="${waLink}" target="_blank" rel="noopener">Send</a>
            <button class="copy-btn" data-index="${start+idx}">Copy</button>
          </div>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;

    const totalPages = Math.ceil(messages.length / perPage);
    el('pager').style.display = totalPages>1 ? 'flex' : 'none';
    el('pageInfo').textContent = `Page ${page} of ${totalPages}`;

    document.querySelectorAll('.copy-btn').forEach(b=>{
      b.onclick = () => {
        const i = Number(b.getAttribute('data-index'));
        navigator.clipboard.writeText(messages[i].msg).then(()=> {
          const old = b.textContent;
          b.textContent = 'Copied';
          setTimeout(()=> b.textContent = old, 1400);
        });
      };
    });
  }

  function escapeHtml(s){
    if(!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  document.getElementById('darkToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('dark');
    document.getElementById('darkToggle').textContent = document.body.classList.contains('dark') ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode';
  });

  document.getElementById('prevBtn').addEventListener('click', ()=>{
    if(currentPage>1){ currentPage--; renderPage(currentPage); }
  });
  document.getElementById('nextBtn').addEventListener('click', ()=>{
    const totalPages = Math.ceil(messages.length / perPage);
    if(currentPage < totalPages){ currentPage++; renderPage(currentPage); }
  });

  document.getElementById('generateBtn').addEventListener('click', ()=> {
    const f = document.getElementById('excelFile').files[0];
    const dateVal = document.getElementById('reportDate').value;
    if(!f) return alert('Please upload an Excel file (.xlsx/.xls).');
    if(!dateVal) return alert('Please select a date.');
    const prettyDate = formatDatePretty(dateVal);

    const reader = new FileReader();
    reader.onload = (e) => {
      const workbook = XLSX.read(new Uint8Array(e.target.result), { type:'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header:1, blankrows:false });
      messages = [];
      currentPage = 1;

      for(let i=3;i<rows.length;i++){
        const row = rows[i];
        if(!row || !row[1]) continue;
        const branch = row[1] || '';
        const mobile = row[3] || '';
        const msg = buildMessage(row, prettyDate);
        messages.push({ branch, mobile: sanitizeMobile(mobile), msg });
      }

      if(messages.length===0){
        document.getElementById('tableWrap').innerHTML = '<div style="padding:18px;color:#6b7280;">No valid rows found starting from row 4.</div>';
        document.getElementById('pager').style.display='none';
        return;
      }
      renderPage(1);
    };
    reader.readAsArrayBuffer(f);
  });

})(); // IIFE
</script>
</body>
</html>